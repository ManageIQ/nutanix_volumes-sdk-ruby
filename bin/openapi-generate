#!/bin/bash

if [ -z "$INPUT_SPEC_VERSION" ]; then
  echo "ERROR: INPUT_SPEC_VERSION must be set"
  exit 1
fi

if [ -z "$OPENAPI_GENERATOR_JAR" ]; then
  # Detect the latest version of the openapi-generator-cli package
  version=`wget https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/maven-metadata.xml -O - 2>/dev/null | xq -x "//metadata/versioning/latest"`
  OPENAPI_GENERATOR_JAR=openapi-generator-cli-$version.jar

  # Download the openapi-generator-cli jar if we don't already have it locally
  if [ ! -f "$OPENAPI_GENERATOR_JAR" ]; then
    echo "Downloading '$OPENAPI_GENERATOR_JAR'..."
    wget https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/$version/$OPENAPI_GENERATOR_JAR
  fi
fi

# Clear out any existing files in paths that are autogenerated to prevent deleted files
# from remaining after running the generate
rm -rf ./docs ./lib ./spec

# Generate the gem from the current openapi-spec
input_spec=https://developers.nutanix.com/api/v1/namespaces/volumes/versions/$INPUT_SPEC_VERSION/yaml

# Fixup issues with the generated classes
export RUBY_POST_PROCESS_FILE="$PWD/bin/openapi-generate-ruby-post-process"

java -jar $OPENAPI_GENERATOR_JAR generate --enable-post-process-file --input-spec $input_spec --skip-validate-spec --generator-name ruby --config .openapi-config.json
